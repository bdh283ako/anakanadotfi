name: Check Pages

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *' # every 6 hours

jobs:
  smoke-test:
    name: Smoke test Pages site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine domain to check
        id: domain
        run: |
          if [ -f CNAME ]; then
            echo "domain=$(cat CNAME)" >> "$GITHUB_OUTPUT"
          else
            echo "domain=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> "$GITHUB_OUTPUT"

      - name: Check site is reachable
        run: |
          echo "Checking ${{ steps.domain.outputs.domain }}"
          curl -sSfL "${{ steps.domain.outputs.domain }}" -o /dev/null

      - name: Install Java for vnu
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre-headless wget

      - name: Download vnu.jar
        run: |
          wget -q -O vnu.jar https://github.com/validator/validator/releases/latest/download/vnu.jar

      - name: Validate HTML with vnu
        run: |
          echo "Validating index.html with vnu"
          java -jar vnu.jar --format json index.html > vnu-out.json || true
          python3 - <<'PY'
import json,sys
j=json.load(open('vnu-out.json'))
msgs=j.get('messages',[])
if msgs:
  from collections import Counter, defaultdict
  types = Counter(m.get('type','unknown') for m in msgs)
  print('HTML validation messages found:')
  for t,c in types.items():
    print(f' - {t}: {c}')
  print('\nDetailed messages:')
  for m in msgs:
    loc = ''
    if m.get('lastLine'):
      loc = f"{m.get('lastLine')}:{m.get('lastColumn')}"
    print(f"[{m.get('type')}] [{loc}] {m.get('message')}")
  sys.exit(1)
else:
  print('No HTML validation messages.')
PY
